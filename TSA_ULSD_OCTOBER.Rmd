---
title: "TSA - ULSD"
author: "Nathaniel McNalley, Fashuai Li, Hongtian Fu, and Taylor Armbruster"
date: "`r Sys.Date()`"
output: html_document
resource_files:
- TSA_template.Rmd
- TSA_template.Rmd
---

<style type="text/css"> body, td {font-size: 12px;} code.r{font-size: 10px;} pre {font-size: 10px} </style>

```{r, echo = F, warning=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = F,warning = F,message = F, fig.width = 4, fig.height = 3,fig.align = "center",tidy = FALSE, strip.white = TRUE)
library(RTL)
library(plotly)
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(scales)
#Morningstar API Login
iuser = "morningstar.ctrd@ualberta.ca"
ipassword = "oRakvwtPVg"
EIAkey = "7658ca55759776ff3116f4e3e927948e"
```

**this template is a guide to organize your project in a clear manner**

**quality of presentation refers amongst others to showing code, tables and charts in a manner that flows with your story. Details and computations shall remain in the code chunks without being rendered into the html output.**

## Experimentation Part

```{r}
#Extracting the March and April Contracts
df <- RTL::getPrices(
  feed = "CME_NymexFutures_EOD",
  contracts = c("@HO22H","@HO22J","@CL22H","@CL22J"),
  from = "2010-01-01",
  iuser = iuser,
  ipassword = ipassword) 
#Extracting the 1st and 2nd Contracts
df2 <- RTL::getPrices(
    feed = "CME_NymexFutures_EOD_continuous",
    contracts = c("HO_001_Month","HO_002_Month","CL_001_Month","CL_002_Month"),
    from = "2010-01-01",
    iuser = iuser,
    ipassword = ipassword)
#Joining the Data Frames, converting to barrels, and calculating spreads
HOdf <- dplyr::inner_join(df,df2) %>% 
    dplyr::arrange(dplyr::desc(date)) %>% 
  stats::na.omit()%>% 
  dplyr::transmute(date = date,
                   HO_01 = HO_001_Month * 42,
                   HO_02 = HO_002_Month * 42,
                   CL_01 = CL_001_Month,
                   CL_02 = CL_002_Month,
                   HO22H = HO22H * 42,
                   HO22J = HO22J * 42,
                   CL22H = CL22H,
                   CL22J = CL22J,
                   HO_c1c2_Spd = HO_01 - HO_02,
                   HO_Apr22_Mar22_Spd = HO22H - HO22J,
                   HO_Crack_Spd = HO22H - CL22H) %>% 
#Converting from wide to long
  tidyr::pivot_longer(-date, values_to = "Price", names_to = "Contracts")
```

```{r}
#Plotting flat price for 1st and 2nd contracts
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "_0")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~ Contracts,
    type = 'scatter',
    mode = 'lines'
  ) %>% 
  plotly::layout(
    title = "Flat Price USLD vs. WTI", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

```{r}
#Plotting flat price for March and April contracts 
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts,c("CL22H", "CL22J", "HO22H", "HO22J")))%>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~ Contracts,
    type = 'scatter',
    mode = 'lines'
  ) %>% 
  plotly::layout(
    title = "Flat Price March & April", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```


```{r}
#Time spread 1st and 2nd contracts for ULSD
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "c1c2")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "Time Spread: HO_01 vs HO_02", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

```{r}
#Time spread for March and April ULSD contracts 
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "Apr")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "Time Spread: March and April 2022", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

```{r}
#Crack spread between ULSD and WTI
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "Crack")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "ULSD Crack Spread: WTI March 2022", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

## Summary
The main futures contracts used to trade ULSD will be the NY Harbor ULSD Futures (ticker HO). These contracts are standardized to 42,000 gallons (1,000 barrels). The ULSD delivery location is New York Harbor with options for delivery into the buyer's barge, tanker, or pipeline if they are able. The product must meet the specification of the Colonial Pipeline's Fungible Grade 62 for Ultra Low Sulfur Diesel and must be designated for sale in accordance with U.S. Environmental Protection Agency regulations. As of 2016, almost all petroleum-based diesel fuel available in the UK, mainland Europe, and North America is ultra low sulphur. 

NY Harbor ULSD Futures Handbook: https://www.cmegroup.com/content/dam/cmegroup/rulebook/NYMEX/1a/150.pdf  

ULSD is also commonly referred to as distillate and is the second-most consumed petroleum product in the United States. In addition to its use as a transportation fuel, distillate is also consumed for heating and power generation purposes. Distillate's use as a heating fuel drives the seasonal pattern of higher consumption during the winter months. Distillate consumption is affected by economic growth and weather conditions as well as vehicle efficiency and miles traveled of heavy-duty vehicles.

Components of the price you see at the pumps: The cost of crude oil purchased by refineries, refining costs, distribution and marketing costs, and state taxes all influence the price you see at the pumps.

### What's changed

### Current Exposure

### New Trades if any


### Supply Demand Indicators

```{r}
#Implied storage builds and draws
library(RTL)
data("tickers_eia")
sd <- tickers_eia %>% dplyr::filter(sd_category == "dist", category != "stocks") %>% 
dplyr::as_tibble()

eia_df <- tibble::tribble(~ticker, ~name) %>% 
  add_row(ticker = sd$tick.eia[1:nrow(sd)], name = sd$tick.r[1:nrow(sd)]) %>% 
  dplyr::mutate(key = EIAkey) %>% 
  dplyr::mutate(df = purrr::pmap(list(ticker, key, name), .f = RTL::eia2tidy)) %>% 
  dplyr::select(df) %>% tidyr::unnest(df)

data2 <- eia_df %>% 
  tidyr::pivot_wider(date, names_from = series, values_from = value) %>% 
  dplyr::rename(Demand = eia.mdist.demand, Imports = eia.mdist.imports, Supply = eia.mdist.supply, Exports = eia.mdist.exports) %>%   dplyr::arrange(date) %>% 
  dplyr::filter(date >= "2018-01-01") %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Storage = Supply + Imports - Demand - Exports)

#Graphical Transformation
fig.title = "ULSD SD Balance Including Implied Storage Builds/Draws"
p <- data2 %>% 
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value") %>% 
  ggplot(aes(x = date, y = value, color = series)) + 
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = fig.title, y = "kbd", x = "")
p %>% plotly::ggplotly(width = 700, height = 400,)
```

Production: Most of the diesel fuel produced and consumed in the US is refined from crude oil at petroleum refineries within the US. These refineries produce an average of 11 to 12 gallons of diesel fuel for every 42 gallon barrel of crude. Production decisions by refineries are also effected by the spread between diesel and gasoline prices as when the spread widens refineries increase the amount of diesel that they produce relative to gasoline. The standard crack-spread at refineries is generally 3-2-1, meaning that for 3 barrels of crude that 2 will be refined into gasoline and 1 will be refined into ULSD. In our SD balance Supply represents U.S. domestic production of ULSD. ULSD production is vitally important to the functioning of the U.S. economy as it is the dominant fuel for freight transportation and heavy machinery. 

In the short term we believe that supply is relatively inelastic with production in the U.S. accounting for roughly 4.8 million barrels fo ULSD a day. In the longer term production is more elastic allowing refineries to increase the amount of ULSD that they produce if market conditions are accommodative. This would include higher ULSD prices from heightened demand. From our SD balance we can see the weekly changes in U.S. supply from refineries. 

Consumption: More than 8 million hones in New England and the Central Atlantic Region of the US lack access to natural gas so they use Heating Oil (ULSD). This makes one of ULSDâ€™s end markets consumers those who require ULSD for their home heating needs. Due to this there is some seasonality in pricing during the cold winter months. Residential heating oil consumption peaked in the 1970's and declined nearly every year since. 81%  of residential heating use is concentrated in the US Northeast including New York, Pennsylvania, and New England. Diesel is mainly used as a transport fuel and consumption is impacted by the underlying economic conditions, fuel efficiency, and miles traveled by heavy duty vehicles. In 2020, diesel fuel consumption was about 44.61 billion gallons which averages to about 3 million barrels per day. PADD 3 has been a net exported of diesel since 2001 which is logical given the number of refineries located in the US Gulf Coast and the fuel needs across the US. In our SD balance Demand represents the consumption of ULSD. Demand is important as it gives us a sense of the daily needs of the U.S. for heating and transportation. 

In the short term we see demand increasing going into the holiday season as supply chain issues will require higher volumes of transport of freight across the US. Additionally, we are headed into the colder months of the year which will contribute to excess demand for home heating needs in the U.S. Northwest. In the longer term we believe that demand will stabilize following the winter season and after much of the U.S. supply chain congestion has been remedied. From our SD balance we are able to see weekly changes in the demand for ULSD. 

Net Exports: The U.S. is a net exporter of ULSD meaning that they export far more ULSD than they import. This is important as domestic production is being directed to producing ULSD which will be sent internationally instead of for meeting domestic demand and building inventories. Our SD balance shows both imports and exports for the U.S. meaning that we can analyze them separately. International trade of ULSD is very important as ULSD is being redirected to outside markets instead of being used domestically and is materially important for analyzing inventory builds and draws.

In the short term we believe that exports will decrease relative to imports to attempt and meet domestic needs during the winter months but that this reduction will be short-lived and is not likely to be enough to satisfy demand needs.

Storage: Inventories of ULSD are vitally important in the U.S. as higher demand in the winter months due to home heating needs can cause inventory draws. Consistent draws can lead to lower inventories and will eventually put upward pressure on prices to attract ULSD to that market. Inventory draws and builds are shown in the SD balance as Storage. Generally, during the summer months and approaching the winter months the U.S. will build up inventories of ULSD in preparation for higher demand in the winter. 

In 2021 it appears that due to high demand and exports relative to supply inventories were not built up. In the short term we expect that the lack of inventory builds will lead to higher prices for ULSD in the near term, especially in the later winter months closer to March. In the longer term as supply chain congestion is resolved and demand lessens for home heating we expect inventories to begin to build as they do typically. 

Transportation: Most diesel fuel moves by pipeline from refineries and ports to terminals near major consuming areas. Barges and trains also move diesel to terminals. Trucks transport the diesel fuel from the terminals to retail service stations and to large volume consumers such as fleet operators. Most of the U.S. refining capacity can be found in PADD 3 around the Gulf Coast and as such PADD 3 is a net exporter of ULSD. A large amount of demand in the colder winter months is located in PADD 1 and due to their low refining capacity they require imports of ULSD from refineries concentrated in PADD 3.
```{r, eval=FALSE}
#Infrastructure Mapping
fig.title = "ULSD Trade Infrastructure Map"
productspipelines <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Pipelines_US_EIA.zip")
productsterminals <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Terminals_US_EIA.zip")
refineries <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/Petroleum_Refineries_US_EIA.zip")

```




```{r}
#download and save weather data into local:

# library(riem)
# station_id_vec = c("NYC","PHL","BOS","BDR","PWM")
# 
# 
# weather <-
#   riem::riem_measures(station = station_id_list[[2]],
#                       date_start = "2010-01-01",
#                       date_end = Sys.Date()) %>%
#   tidyr::separate(valid, c("date", "time"), sep = " ") %>%
#   base::subset(select = c(date, tmpf)) %>%
#   dplyr::group_by(date) %>%
#   dplyr::mutate(temp = mean(tmpf)) %>%
#   ungroup(date) %>% dplyr::select(-tmpf) %>% distinct() %>%
#   stats::na.omit() %>% dplyr::mutate(date = as.Date(date))
# 
# 
# weather  
# write.table(weather,"PWM.csv",sep = ",")
```

```{r eval=FALSE}
#load data from csv files

library(dplyr)
df_NYC = read.csv("NYC.csv",sep = ",")
df_PHL = read.csv("PHL.csv",sep = ",")
df_BOS = read.csv("BOS.csv",sep = ",")
df_BDR = read.csv("BDR.csv",sep = ",")
df_PWM = read.csv("PWM.csv",sep = ",")


list_wea <- list(df_NYC,df_PHL,df_BOS,df_BDR,df_PWM)
list_reg <- list("NYC","PHL","BOS","BDR","PWM")
list_range <- c(1,2,3,4,5)

for (i in list_range) {
  list_wea[[i]] <- list_wea[[i]] %>% 
  dplyr::mutate(
    region = list_reg[[i]]
  )
}

  
#transfer date into date type  
df_weather <-list_wea %>% 
  dplyr::bind_rows(list_wea,id=NULL) %>% 
  dplyr::group_by(region)

df_weather$date = as.Date(df_weather$date)
df_weather

```


```{r eval=FALSE}
#we need to analyze the temperature data for these 5 regions(New York,Pennsylvania,Massachusetts,Connecticut,Maine)

fig.title = "Northeast Temperature"

p <- df_weather %>%
  ggplot(aes(
    y = temp,
    x = date,
    col = region,
    alpha = 0.1,
    show.legend = FALSE
  )) +
  geom_point() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(
    title = "Northeast Region Temperature",
    caption = "Source: IEM",
    y = "Temperature (F)",
    x = ""
  )
ggplotly(p)

```

```{r}
library(RTL)
fig.title = "ULSD Trade Infrastructure Map"


productspipelines <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Pipelines_US_EIA.zip")

productsterminals <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Terminals_US_EIA.zip")

refineries <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/Petroleum_Refineries_US_EIA.zip")

require(leaflet)
leaflet() %>%
  addTiles() %>%
  setView(lng = -96, lat = 35, zoom = 3) %>%
  leaflet::addLegend(
    "topleft",
    colors = c("blue", "red", "green"),
    labels = c("Refinery (with Cokers in black)", "Products Pipe", "Terminals"),
    opacity = 0.8
  ) %>%
  addPolylines(
    data = productspipelines,
    color = "red",
    weight = 0.8,
    popup = ~ Pipename,
    group = "Products Pipe"
  ) %>%
  addCircleMarkers(
    data = refineries,
    color =  ~ dplyr::case_when(Cokin_Mbpd > 0 ~ "black", TRUE ~ "blue"),
    radius = ~ AD_Mbpd / 100,
    popup = ~ paste0(Corp, "-", Site),
    group = "Refinery"
  ) %>%
  addCircleMarkers(
    data = productsterminals,
    color = ~ "green",
    radius = 1,
    popup = ~ Site,
    group = "Terminals"
  ) %>%
  addLayersControl(
    overlayGroups = c("Refinery", "Products Pipe", "Terminals"),
    options = layersControlOptions(collapsed = F)
  )
```

```{r}
require(tidyverse)
require(purrr)
require(RTL)

eia_df <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.WD0ST_R1X_1.W", "New England (PADD 1A )", "sink", 
  "PET.WD0ST_R1Y_1.W", "Central Atlantic (PADD 1B)", "sink", 
  "PET.WD0ST_R1Z_1.W", "Lower Atlantic (PADD 1C)", "sink", 
  "PET.WD0ST_R20_1.W", "Midwest (PADD 2)", "sink", 
  "PET.WD0ST_R30_1.W", "Gulf Coast (PADD 3)", "sink", 
  "PET.WD0ST_R40_1.W", "Rocky Mountain (PADD 4)", "sink", 
  "PET.WD0ST_R50_1.W", "West Coast (PADD 5)", "sink", 
  )  # create a data frame with all the tickers 
# create data pull function to access EIA API pull data and clean and convert data to the correct formation
data <- eia_df %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest()
data
```
```{r}
fig.title = " Ending Stocks of Distillate Fuel Oil, 0 to 15 ppm Sulfur"
library(scales)
p1 <-
  data %>% dplyr::filter(param %in% c("New England (PADD 1A )","Central Atlantic (PADD 1B)","Midwest (PADD 2)","Gulf Coast (PADD 3)","Rocky Mountain (PADD 4)","West Coast (PADD 5)")) %>%
  ggplot(aes(x = date, y = value, color = param)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle(fig.title)
p1 %>% plotly::ggplotly()
```

```{r}
require(tidyverse)
require(purrr)
require(RTL)

eia_df2 <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.WD0IM_R10-Z00_2.W", "East Coast (PADD 1)", "source", 
  "PET.WD0IM_R20-Z00_2.W", "Midwest (PADD 2)", "source",
  "PET.WD0IM_R30-Z00_2.W", "Gulf Coast (PADD 3)", "source",
  "PET.WD0IM_R40-Z00_2.W", "Rocky Mountain (PADD 4) ", "source",
  "PET.WD0IM_R50-Z00_2.W", "West Coast (PADD 5) ", "source",
  )  # create a data frame with all the tickers 
# create data pull function to access EIA API pull data and clean and convert data to the correct formation

data2 <- eia_df2 %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest()
data2

fig.title = "Import of Distillate Fuel Oil, 0 to 15 ppm Sulfur"
library(scales)
p1 <-
  data %>% dplyr::filter(param %in% c("East Coast (PADD 1)","Midwest (PADD 2)","Gulf Coast (PADD 3)","Rocky Mountain (PADD 4) ","West Coast (PADD 5) ")) %>%
  ggplot(aes(x = date, y = value, color = param)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle(fig.title)
p1 %>% plotly::ggplotly()

```

```{r}
require(tidyverse)
require(purrr)
require(RTL)

eia_df3 <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.WDIEXUS2.W", "U.S. Exports of Total Distillate", "output", 

  )  # create a data frame with all the tickers 
# create data pull function to access EIA API pull data and clean and convert data to the correct formation

data3 <- eia_df3 %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest()
data3

fig.title = "Export of Distillate Fuel Oil, 0 to 15 ppm Sulfur"

library(scales)
p3 <-
  data3  %>%
  ggplot(aes(x = date, y = value, color = param)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle(fig.title)
p3 %>% plotly::ggplotly()
```


```{r}
require(tidyverse)
require(purrr)
require(RTL)

eia_df5 <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.MD0UP_R10_1.M", "East Coast (PADD 1)", "output", 
"PET.MD0UP_R20_1.M", "Midwest (PADD 2)", "output",
"PET.MD0UP_R30_1.M", "Gulf Coast (PADD 3)", "output",
"PET.MD0UP_R40_1.M", "Rocky Mountain (PADD 4)", "output",
"PET.MD0UP_R50_1.M", "West Coast (PADD 5) ", "output",
  )  # create a data frame with all the tickers 
# create data pull function to access EIA API pull data and clean and convert data to the correct formation

data5 <- eia_df5 %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest()
data5

fig.title = "Product Supplied/Consumption of Distillate Fuel Oil, 0 to 15 ppm Sulfur"

library(scales)
p5 <-
  data %>% dplyr::filter(param %in% c("East Coast (PADD 1)","Midwest (PADD 2)","Gulf Coast (PADD 3)","Rocky Mountain (PADD 4)","West Coast (PADD 5) ")) %>%
  ggplot(aes(x = date, y = value, color = param)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle(fig.title)
p5 %>% plotly::ggplotly()
```


```{r}
library(prophet)

p10 <- data2 %>% dplyr::select(date, Demand)%>%
  dplyr::rename(ds = date, y = Demand) %>%
  dplyr::select(ds, y)
m <- prophet(p10)
future <- prophet::make_future_dataframe(m, periods = 12, freq = "month")
tail(future)
forecast <- predict(m, future)
tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])
p11 <- plot(m, forecast, xlabel = "", ylabel = "kbd")
ggplotly(p11)
```

```{r}
prophet::prophet_plot_components(m, forecast)
```
### Market View
```{r}
#Pulling the Forward Curve for HO
fig.title = "Heating Oil Futures Forward Curve"
HO_Curve <- RTL::getCurve(
  feed = "Crb_Futures_Price_Volume_And_Open_Interest",
  contract = "HO",
  date = "2021-10-15",
  iuser = iuser,
  ipassword = ipassword
) %>% 
  dplyr::select(c("contract", "Close")) %>% 
  dplyr::mutate(Close = Close * 42)
HO_Curve %>% 
  plot_ly(
     width = 700, height = 400,
    x = ~contract,
    y = ~Close,
    type = "scatter",
    mode = "markers",
    name = "Forward Curve") %>% 
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(
      title = "Contract",
      categoryorder = "array",
      categoryarray = ~ contract
    ),
    yaxis = list(title = "$ per bbl")
  )
```

```{r}
eia_df <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "STEO.DFPSPUS.M", "Inventory", "Source"
  )
data <- eia_df %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest() %>% 
  dplyr::filter(date>="2018-01-01")
data

p1 <-
  data %>%
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle('Distillate Fuel Oil U.S. Total Inventory, Monthly')
p1 %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
#pulling in days of inventory of distillate
eia_df <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.W_EPD0_VSD_NUS_DAYS.W", "Value", "Source"
  )
days_supply <- eia_df %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest(cols = c(data)) %>% 
  dplyr::select(date, series, value)
```

+ What we see currently in the ULSD market is that refinery output for the next few quarters is constrained with any increases in domestic US supply being the result of a decrease in net exports in the short-term. In this sense domestic supply is only expected to increase by ~300 thousand barrels a day going into the winter season. 
+ With supply accounted for we need to make some assumptions about demand in the short and long term. In the short term we expect to see higher demand as a result of the cold winter months and home heating requirements, along with a continue push to solve supply chain issues across the US which would require an increase in freight transport during the holiday shopping season. Each of these factors leads us to believe that demand for ULSD in the next few quarters will be strong and outstrip US supply in the near-term.
```{r, eval=FALSE}
Consumption <- read.csv(file = "~/Practice/consumption_distillate_retail_2.csv")
p20 <- Consumption %>% group_by(YEAR) %>% group_by(quarter)
Consumption %>% plot_ly() %>% add_trace(x = p20, y = ~distillate_fuel, type = 'bar', xaxis = ~YEAR, yaxis = "y", name = 'distillate_fuel') %>% add_trace(x = p20, y = ~heating_retail, type = "scatter", mode = "lines+markers", yaxis = "y2", name = 'heating_retail') %>% layout(yaxis = list(side = "left"), yaxis2 = list(side = "right", overlaying = "y"), showlegend = TRUE)
```
+ US distillate oil days of supply has been on a downward trend since late January 2021 with less than 36 days of supply since August. 
+Going into the winter months we would expect to see inventories increasing but with the prolonged downward trend it appears that inventory builds will solely be driven by changes in net exports as supply from refineries appears to be inelastic. If demand in the US market during the winter months increases more than the change in net exports we can expect to see increases in inventory draws and decreases in days of distillate supply. 

+ View based on SD indicators ensuring that your conclusions are clearly readable from your charts.
+ Build analytics that is relevant to your current view.
+ If you have explored more, put them in an appendix. 

+ US distillate oil days of supply has been on a downward trend since late January 2021 with less than 36 days of supply since August. 
+Going into the winter months we would expect to see inventories increasing but with the prolonged downward trend it appears that inventory builds will solely be driven by changes in net exports as supply from refineries appears to be inelastic. If demand in the US market during the winter months increases more than the change in net exports we can expect to see increases in inventory draws and decreases in days of distillate supply. 

## Desired Exposure


Translating your market view into strength of market call and allocate risk versus maximum limit

+ As we believe that demand will outstrip supply in the near term we expect to see prices rise in the next two quarters. This means that we expect to go long ULSD in the near term and if we are going to take a short position we would be taking that position outside of the nearest two quarters. We believe that the most likely timing of demand outstripping supply will occur during the winter season meaning that we will want to be long during this period. 
+ Evidence of converting market view into a strength of market call.
+ Strength of market call translates into allocating risk allocation vs your limits.

## Monetization Strategies

```{r}
#Putting together days of supply and price strategies (crack spread, time spread, flat price)
#Extracting the 1st and 2nd Contracts
df2 <- RTL::getPrices(
    feed = "CME_NymexFutures_EOD_continuous",
    contracts = c("HO_001_Month","HO_002_Month","CL_001_Month"),
    from = "2010-01-01",
    iuser = iuser,
    ipassword = ipassword)
#Joining the Data Frames, converting to barrels, and calculating spreads
 Comp_df <-  df2 %>%  dplyr::arrange(dplyr::desc(date)) %>% 
  stats::na.omit()%>% 
  dplyr::transmute(date = date,
                   HO_01 = HO_001_Month * 42,
                   HO_02 = HO_002_Month * 42,
                   CL_01 = CL_001_Month,
                   Time_Spread = HO_01 - HO_02,
                   Crack_Spread = HO_01 - CL_01)
 
#Converting days of supply wider
days_supply <- days_supply %>% 
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::rename(Days_Supply = PET.W_EPD0_VSD_NUS_DAYS.W)
 
#Put together and converting from wide to long
Comp_df <- dplyr::inner_join(days_supply,Comp_df) %>% 
  dplyr::select(-HO_02 & -CL_01) %>% 
  dplyr::rename(Flat_Price = HO_01) %>% 
  tidyr::pivot_longer(-date, values_to = "value", names_to = "series")

fig.title = "Flat Price, Time Spread, and Crack Spread Compared to Days of Supply"
t <- Comp_df %>% 
  ggplot(aes(x = date, y = value, color = series)) + 
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = fig.title, y = "Value", x = "")
 t %>% plotly::ggplotly(width = 700, height = 400,)
```
From our analysis of days of supply and various strategies we found that only a few strategies appears to show some form of relationship with days of supply. There does not appear to be a discernible relationship between flat price and days of supply other than the slight lag consistent with producers stockpiling inventories at lower ULSD prices to profit off of future price increases. Time spreads appear to be at their most extreme during the first quarter of the year which is consistent with changes in seasonality at the end of winter. There does appear to be an inverse relationship between days of supply and time-spreads that can be observed when time spreads spike. In the cases of the 2014 and 2015 spikes in time spreads to the double digit range supplies reached a trough before building up again following the winter months. There also appears to be an inverse relationship between the crack spread and the number of days of supply. Generally, when days of supply of ULSD is high the crack spread is low which makes sense as large inventories of ULSD would decrease the price of ULSD relative to CL. Days of supply peaked during the early parts of the COVID-19 Pandemic and corresponds to a steep decline in the crack spread. 

Given our market view that inventories will be pressured in the short-term due to lack of inventory builds prior to the winter we expect to see increases in both the crack and time spreads. At the time of writing the U.S. has roughly 31 days of supply and with the belief that this could go lower during the winter months if export reductions are not significant enough we could expect to see sub-30 days of supply which corresponds to crack spreads upwards of $26 in recent years and time spreads which could reach the low-to-mid teen range if demand is especially high during the end of the winter when inventories have been run down.  

There are a few ways for us to profit off of our market call including making trades on flat price, time spread, and crack spread. With the historical volatility of flat price being quite high we would prefer to make trades based on other strategies. 
We considered a time spread that was long a contract expiring within the next two quarters and being short a contract in the second quarter of 2022. This would mean that we would profit off of any increase in price in the near-term and price decreases following the winter months, aligning with our market view.

We have also considered a strategy involving the crack spread where we would be long ULSD and short CL with the expectation that heightened demand in ULSD will increase the crack spread. This would also allow for possible changes in CL prices in the case that OPEC or US producers increased the supply of CL leading to decreases in the prices of both commodities. With the belief that demand and supply in the short-term for ULSD is relatively inelastic we would expect that price for ULSD to fall at a slower rate than CL in the near-term and for that difference in spread to balance out in the longer term following the holiday season. 

## Risk Appetite

```{r}
library(tibbletime)
# Using RTL and Morningstar to retreive contract data
df <-  RTL::getPrices(
  feed = "CME_NymexFutures_EOD_continuous",
  contracts = paste0("HO_", sprintf('%0.3d', 1:36), "_Month"),
  from = "2015-01-01",
  iuser = iuser,
  ipassword = ipassword
) %>%
  dplyr::filter(!date %in% c(as.Date("2020-04-20")))

df <- df %>%
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value") %>%
  dplyr::mutate(series = stringr::str_replace_all(series, c("_0" = "", "_Month" = ""))) %>%
  dplyr::group_by(series) %>%
  dplyr::mutate(
    ret_abs = value - dplyr::lag(value),
    ret_rel = (value / dplyr::lag(value)) - 1,
    ret_log = log(value / dplyr::lag(value))
  ) %>%
  stats::na.omit()
## Pivot prices into a wide data frame
prices <- df %>% dplyr::select(date, series, value) %>%
  tidyr::pivot_wider(values_from = value, names_from = series)
prices

```


```{r}
## Pivot returns into a wide data frame
ret_abs <- df %>% dplyr::select(date, series, ret_abs) %>%
  tidyr::pivot_wider(values_from = ret_abs, names_from = series)
ret_log <- df %>% dplyr::select(date, series, ret_log) %>%
  tidyr::pivot_wider(values_from = ret_log, names_from = series)
```

```{r}
fig.title = "ULSD Front Contract Absolute Returns"
ret.adj <- RTL::rolladjust(
  x = ret_abs[, 1:2],
  commodityname = c("cmeulsd"),
  rolltype = c("Last.Trade")
) %>%
  mutate(CL01 = cumsum(HO01)) %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>%
  dplyr::mutate(series = "adj")
ret.unajd <- ret_abs[, 1:2] %>% mutate(HO01 = cumsum(HO01))
ret.unajd %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>%
  rbind(ret.adj) %>%
  ggplot(aes(x = date, y = value, col = series)) + geom_line() +
  labs(
    title = fig.title,
    subtitle = "With and Without Roll Adjustment - series start diverging on the first expiry",
    caption = "Source: CME",
    x = "",
    y = "Cumulative Returns ($)"
  )
```

```{r}
# Roll Adjustment
library(moments)
ret.log.adj <-
  RTL::rolladjust(
    x = ret_log,
    commodityname = c("cmeulsd"),
    rolltype = c("Last.Trade")
  ) %>%
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value")

x <- ret.log.adj %>%
  stats::na.omit() %>%
  dplyr::group_by(series) %>%
  dplyr::summarize(
    mean = mean(value),
    stddev = sd(value),
    kurtosis = moments::kurtosis(value),
    skewness = moments::skewness(value),
    .groups = "keep"
  )
x
```

```{r}
fig.title = "Risk versus Time to Delivery"

sd.simple <- ret.log.adj %>%
  group_by(series) %>%
  dplyr::summarize(stddev = sd(value) * sqrt(252), .groups = "keep")

sd.simple %>% ggplot(aes(x = series, y = stddev)) + geom_point(col = "blue") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(labels = percent) +
  labs(
    title = fig.title,
    subtitle = "notice the volatility cone shape: risk is a function of maturity",
    x = "Contracts",
    y = "Annualized Percentage Volatility"
  )
```

```{r}
fig.title = "Plotly Box Plot"
ret.log.adj %>% plot_ly(
  y = ~ value,
  color = ~ series,
  type = "box",
  colors = c("blue", "orange")
)  %>%
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(title = ""),
    yaxis = list(
      title = "Daily Returns",
      separators = '.,',
      tickformat = ".0%"
    )
  )
```

```{r}
library(tibbletime)
# Define the rolling function using rollify()
sd20 <- tibbletime::rollify(stats::sd, window = 20)
# We use long data frames in large data sets
ret.roll <- tibbletime::as_tbl_time(ret.log.adj, index = date) %>%
  dplyr::group_by(series) %>%
  dplyr::mutate(sd20 = sd20(value) * sqrt(252)) %>%
  dplyr::ungroup() %>% stats::na.omit()
# Since series is numeric, we use as.factor to have discrete scale
ret.roll %>% dplyr::filter(series %in% c("HO01", "HO06", "HO12", "HO36")) %>%
  plotly::plot_ly(
    x = ~ date,
    y = ~ sd20,
    name = ~ series,
    color = ~ series
  ) %>%
  plotly::add_lines() %>%
  plotly::layout(
    title = list(text = "Heteroskedasticity", x = 0),
    xaxis = list(title = ""),
    yaxis = list(title = "Annualized Volality", tickformat = ".0%")
  )
```

```{r}
ret.abs.adj <-
  RTL::rolladjust(
    x = ret_abs,
    commodityname = c("cmeulsd"),
    rolltype = c("Last.Trade")
  )

RTL::promptBeta(
  x = ret.abs.adj,
  period = "all",
  betatype = "all",
  output = "chart"
)

fig.title = "Rolling Correlations"
# Define Rolling Cor from stats::cor() with n=20
# .x and .y and the two generic variables over which we compute return correlation
cor_roll <- tibbletime::rollify( ~ cor(.x, .y), window = 20)

# Data Set in Tibbletime
# Requires time based objects
# Connot cope with non-alphanumeric column names when calling variables in a function

df.corr <- ret.abs.adj %>%
  dplyr::select(date, HO01, HO03, HO12, HO36) %>%
  tibbletime::as_tbl_time(index = date) %>%
  stats::na.omit()

# Applying
df.corr <- df.corr %>%
  dplyr::mutate(
    rho_1_3 = cor_roll(.x = HO01, .y = HO03),
    rho_1_12 = cor_roll(.x = HO01, .y = HO12),
    rho_1_36 = cor_roll(.x = HO01, .y = HO36)
  ) %>%
  stats::na.omit()

# Charting With Minimal Edits if adding more correlations
df.corr %>% dplyr::select(date, contains("rho")) %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>%
  plotly::plot_ly(
    x = ~ date,
    y = ~ value,
    name = ~ series,
    color = ~ series
  ) %>%
  plotly::add_lines() %>%
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(title = ""),
    yaxis = list(title = fig.title, tickformat = ".2f")
  )
```

+ Allocate risk in the context of risk reward ensuring capital preservation.
+ Evidence of a basic framework that you utilize to make your decision. Best is if you can articulate it clearly and quantify it.

## Execution

+ What trades are you executing? 
+ Rationale stated clearly?
+ Entry/ Exit levels stated?
+ 

## Profit and Loss ("PL" Attribution

For each strategy:

+ Provide a grid of PL attribution by risk factors (flat price, time spread, crack,) 
+ Is it in line with your market call? Learnings...

## Lessons Learned

What have you learned from this project?

## Questions for Weekly Meeting with Prof

1. a...
2. b...






