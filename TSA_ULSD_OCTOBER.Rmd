---
title: "TSA - ULSD"
author: "Nathaniel McNalley, Fashuai Li, Hongtian Fu, and Taylor Armbruster"
date: "`r Sys.Date()`"
output: html_document
resource_files:
- TSA_template.Rmd
- TSA_template.Rmd
---

<style type="text/css"> body, td {font-size: 12px;} code.r{font-size: 10px;} pre {font-size: 10px} </style>

```{r, echo = F, warning=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = F,warning = F,message = F, fig.width = 4, fig.height = 3,fig.align = "center",tidy = FALSE, strip.white = TRUE)
library(RTL)
library(plotly)
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(scales)
#Morningstar API Login
iuser = "morningstar.ctrd@ualberta.ca"
ipassword = "oRakvwtPVg"
EIAkey = "7658ca55759776ff3116f4e3e927948e"
```

## Experimentation Part

Below are various charts that will be used as a quick dashboard for various monetization strategies. This includes flat price of ULSD and CL, as CL is a major component in ULSD production, the current crack spread between ULSD and CL, and the time spread between the first and second contract of ULSD.
```{r}
#Extracting the March and April Contracts
df <- RTL::getPrices(
  feed = "CME_NymexFutures_EOD",
  contracts = c("@HO22H","@HO22J","@CL22H","@CL22J"),
  from = "2010-01-01",
  iuser = iuser,
  ipassword = ipassword) 
#Extracting the 1st and 2nd Contracts
df2 <- RTL::getPrices(
    feed = "CME_NymexFutures_EOD_continuous",
    contracts = c("HO_001_Month","HO_002_Month","CL_001_Month","CL_002_Month"),
    from = "2010-01-01",
    iuser = iuser,
    ipassword = ipassword)
#Joining the Data Frames, converting to barrels, and calculating spreads
HOdf <- dplyr::inner_join(df,df2) %>% 
    dplyr::arrange(dplyr::desc(date)) %>% 
  stats::na.omit()%>% 
  dplyr::transmute(date = date,
                   HO_01 = HO_001_Month * 42,
                   HO_02 = HO_002_Month * 42,
                   CL_01 = CL_001_Month,
                   CL_02 = CL_002_Month,
                   HO22H = HO22H * 42,
                   HO22J = HO22J * 42,
                   CL22H = CL22H,
                   CL22J = CL22J,
                   HO_Current_Crack = HO_01 - CL_01,
                   HO_c1c2_Spd = HO_01 - HO_02,
                   HO_Apr22_Mar22_Spd = HO22H - HO22J,
                   HO_Crack_Spd = HO22H - CL22H) %>% 
#Converting from wide to long
  tidyr::pivot_longer(-date, values_to = "Price", names_to = "Contracts")
```

```{r}
#Plotting flat price for 1st and 2nd contracts
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "_0")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~ Contracts,
    type = 'scatter',
    mode = 'lines'
  ) %>% 
  plotly::layout(
    title = "Flat Price USLD vs. WTI", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```
```{r}
#Plotting Current Crack Spread
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "Current_Crack")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "Current ULSD Crack Spread", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```
```{r}
#Time spread 1st and 2nd contracts for ULSD
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "c1c2")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "Time Spread: HO_01 vs HO_02", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

A dashboard for the March and April contracts is also included for the various monetization strategies as there is some seasonality in ULSD demand. This seasonality can lead to profitable trading strategies based on inventories at the end of March and into April. 

```{r}
#Plotting flat price for March and April contracts 
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, c("2H", "2J")))%>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~ Contracts,
    type = 'scatter',
    mode = 'lines'
  ) %>% 
  plotly::layout(
    title = "Flat Price March & April Contracts", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

```{r}
#Crack spread between ULSD and WTI
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "Crack_S")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "ULSD Crack Spread: WTI March 2022", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

```{r}
#Time spread for March and April ULSD contracts 
HOdf %>% 
  dplyr::filter(stringr::str_detect(Contracts, "Apr")) %>% 
  plotly::plot_ly(
     width = 700, height = 400,
    x = ~date,
    y = ~Price,
    name = ~Contracts
  ) %>% 
  plotly::add_lines() %>% 
  plotly::layout(
    title = "Time Spread: March and April 2022", x = 0,
  xaxis = list(title = "Date"),
  yaxis = list(
    title = "$ per Barrel")
  )
```

## Summary
The main futures contracts used to trade ULSD will be the NY Harbor ULSD Futures (ticker HO). These contracts are standardized to 42,000 gallons (1,000 barrels). The ULSD delivery location is New York Harbor with options for delivery into the buyer's barge, tanker, or pipeline if they are able. The product must meet the specification of the Colonial Pipeline's Fungible Grade 62 for Ultra Low Sulfur Diesel and must be designated for sale in accordance with U.S. Environmental Protection Agency regulations. As of 2016, almost all petroleum-based diesel fuel available in the UK, mainland Europe, and North America is ultra low sulphur. 

NY Harbor ULSD Futures Handbook: https://www.cmegroup.com/content/dam/cmegroup/rulebook/NYMEX/1a/150.pdf  

ULSD is also commonly referred to as distillate and is the second-most consumed petroleum product in the United States. In addition to its use as a transportation fuel, distillate is also consumed for heating and power generation purposes. Distillate's use as a heating fuel drives the seasonal pattern of higher consumption during the winter months. Distillate consumption is affected by economic growth and weather conditions as well as vehicle efficiency and miles traveled of heavy-duty vehicles.

Components of the price you see at the pumps: The cost of crude oil purchased by refineries, refining costs, distribution and marketing costs, and state taxes all influence the price you see at the pumps.

### What's changed

### Current Exposure

Our current exposure is long 15 contracts of ULSD in March and short 15 contracts of CL in March to take advantage of our expectations of crack spread widening at lower inventories during the month. 

### New Trades

November 1: When running regression analysis between the time spread of the two closest forward contracts and the days of inventory of ULSD we found that the current c1c2 time spread is on the higher side of the confidence interval. Given our market view that supply in the short-term will be inelastic relative to growing demand we anticipate continued storage draws leading to lower days of supply and a growing time spread. With days of supply falling to 30 or even less as the winter progresses the potential upside from monetizing the time spread could increase to above a dollar from its current 0.6 range in the market. To monetize this strategy we will be long 20 December 2021 and short 20 January 2022 ULSD contracts. The regression used for determining the reasonable range of the time spread based on historical data can be found in the Appendix. 

### Supply Demand Indicators

```{r}
#Implied storage builds and draws
library(RTL)
data("tickers_eia")
sd <- tickers_eia %>% dplyr::filter(sd_category == "dist", category != "stocks") %>% 
dplyr::as_tibble()

eia_df <- tibble::tribble(~ticker, ~name) %>% 
  add_row(ticker = sd$tick.eia[1:nrow(sd)], name = sd$tick.r[1:nrow(sd)]) %>% 
  dplyr::mutate(key = EIAkey) %>% 
  dplyr::mutate(df = purrr::pmap(list(ticker, key, name), .f = RTL::eia2tidy)) %>% 
  dplyr::select(df) %>% tidyr::unnest(df)

data2 <- eia_df %>% 
  tidyr::pivot_wider(date, names_from = series, values_from = value) %>% 
  dplyr::rename(Demand = eia.mdist.demand, Imports = eia.mdist.imports, Supply = eia.mdist.supply, Exports = eia.mdist.exports) %>%   dplyr::arrange(date) %>% 
  dplyr::filter(date >= "2018-01-01") %>% 
  tidyr::drop_na() %>% 
  dplyr::mutate(Storage = Supply + Imports - Demand - Exports)

#Graphical Transformation
fig.title = "ULSD SD Balance Including Implied Storage Builds/Draws"
p <- data2 %>% 
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value") %>% 
  ggplot(aes(x = date, y = value, color = series)) + 
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = fig.title, y = "kbd", x = "")
p %>% plotly::ggplotly(width = 700, height = 400,)
```

Production: Most of the diesel fuel produced and consumed in the US is refined from crude oil at petroleum refineries within the US. These refineries produce an average of 11 to 12 gallons of diesel fuel for every 42 gallon barrel of crude. Production decisions by refineries are also effected by the spread between diesel and gasoline prices as when the spread widens refineries increase the amount of diesel that they produce relative to gasoline. The standard crack-spread at refineries is generally 3-2-1, meaning that for 3 barrels of crude that 2 will be refined into gasoline and 1 will be refined into ULSD. In our SD balance Supply represents U.S. domestic production of ULSD. ULSD production is vitally important to the functioning of the U.S. economy as it is the dominant fuel for freight transportation and heavy machinery. 

In the short term we believe that supply is relatively inelastic with production in the U.S. accounting for roughly 4.8 million barrels fo ULSD a day. In the longer term production is more elastic allowing refineries to increase the amount of ULSD that they produce if market conditions are accommodative. This would include higher ULSD prices from heightened demand. From our SD balance we can see the weekly changes in U.S. supply from refineries. 

Consumption: More than 8 million hones in New England and the Central Atlantic Region of the US lack access to natural gas so they use Heating Oil (ULSD). This makes one of ULSDâ€™s end markets consumers those who require ULSD for their home heating needs. Due to this there is some seasonality in pricing during the cold winter months. Residential heating oil consumption peaked in the 1970's and declined nearly every year since. 81%  of residential heating use is concentrated in the US Northeast including New York, Pennsylvania, and New England. Diesel is mainly used as a transport fuel and consumption is impacted by the underlying economic conditions, fuel efficiency, and miles traveled by heavy duty vehicles. In 2020, diesel fuel consumption was about 44.61 billion gallons which averages to about 3 million barrels per day. PADD 3 has been a net exported of diesel since 2001 which is logical given the number of refineries located in the US Gulf Coast and the fuel needs across the US. In our SD balance Demand represents the consumption of ULSD. Demand is important as it gives us a sense of the daily needs of the U.S. for heating and transportation. 

In the short term we see demand increasing going into the holiday season as supply chain issues will require higher volumes of transport of freight across the US. Additionally, we are headed into the colder months of the year which will contribute to excess demand for home heating needs in the U.S. Northwest. In the longer term we believe that demand will stabilize following the winter season and after much of the U.S. supply chain congestion has been remedied. From our SD balance we are able to see weekly changes in the demand for ULSD. 

Net Exports: The U.S. is a net exporter of ULSD meaning that they export far more ULSD than they import. This is important as domestic production is being directed to producing ULSD which will be sent internationally instead of for meeting domestic demand and building inventories. Our SD balance shows both imports and exports for the U.S. meaning that we can analyze them separately. International trade of ULSD is very important as ULSD is being redirected to outside markets instead of being used domestically and is materially important for analyzing inventory builds and draws.

In the short term we believe that exports will decrease relative to imports to attempt and meet domestic needs during the winter months but that this reduction will be short-lived and is not likely to be enough to satisfy demand needs.

Storage: Inventories of ULSD are vitally important in the U.S. as higher demand in the winter months due to home heating needs can cause inventory draws. Consistent draws can lead to lower inventories and will eventually put upward pressure on prices to attract ULSD to that market. Inventory draws and builds are shown in the SD balance as Storage. Generally, during the summer months and approaching the winter months the U.S. will build up inventories of ULSD in preparation for higher demand in the winter. 

In 2021 it appears that due to high demand and exports relative to supply inventories were not built up. In the short term we expect that the lack of inventory builds will lead to higher prices for ULSD in the near term, especially in the later winter months closer to March. In the longer term as supply chain congestion is resolved and demand lessens for home heating we expect inventories to begin to build as they do typically. 

Transportation: Most diesel fuel moves by pipeline from refineries and ports to terminals near major consuming areas. Barges and trains also move diesel to terminals. Trucks transport the diesel fuel from the terminals to retail service stations and to large volume consumers such as fleet operators. Most of the U.S. refining capacity can be found in PADD 3 around the Gulf Coast and as such PADD 3 is a net exporter of ULSD. A large amount of demand in the colder winter months is located in PADD 1 and due to their low refining capacity they require imports of ULSD from refineries concentrated in PADD 3.
```{r, eval=FALSE}
#Infrastructure Mapping
fig.title = "ULSD Trade Infrastructure Map"
productspipelines <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Pipelines_US_EIA.zip")
productsterminals <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/PetroleumProduct_Terminals_US_EIA.zip")
refineries <- RTL::getGIS(url = "https://www.eia.gov/maps/map_data/Petroleum_Refineries_US_EIA.zip")

```

### Market View

The forward curve for ULSD is provided to get a sense of the state of the market. Currently, the market is in backwardation, meaning that futures prices are decreases with increases in delivery timing.
```{r}
#Pulling the Forward Curve for HO
fig.title = "Heating Oil Futures Forward Curve"
HO_Curve <- RTL::getCurve(
  feed = "Crb_Futures_Price_Volume_And_Open_Interest",
  contract = "HO",
  date = "2021-10-29",
  iuser = iuser,
  ipassword = ipassword
) %>% 
  dplyr::select(c("contract", "Close")) %>% 
  dplyr::mutate(Close = Close * 42)
HO_Curve %>% 
  plot_ly(
     width = 700, height = 400,
    x = ~contract,
    y = ~Close,
    type = "scatter",
    mode = "markers",
    name = "Forward Curve") %>% 
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(
      title = "Contract",
      categoryorder = "array",
      categoryarray = ~ contract
    ),
    yaxis = list(title = "$ per bbl")
  )
```
Both historical ULSD inventories and days of supply have been charted to get a sense of where the market currently is and how it has been trending. Distillate inventories are also forecasted by EIA so there are data points as far as the end of 2022. Days of supply metrics are all based on historically realized values and are updated weekly. 
```{r}
#Pulling Distillate inventories
eia_df <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "STEO.DFPSPUS.M", "Inventory", "Source"
  )
data <- eia_df %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest() %>% 
  dplyr::filter(date>="2018-01-01")

p1 <-
  data %>%
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle('Distillate Fuel Oil U.S. Total Inventory, Monthly')
p1 %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
#pulling in days of inventory of distillate
eia_df <- 
  tibble::tribble(
  ~ticker, ~param, ~type,
  "PET.W_EPD0_VSD_NUS_DAYS.W", "Value", "Source"
  )
days_supply <- eia_df %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(data = purrr::map2(ticker, key, RTL::eia2tidy)) %>%
  dplyr::select(param, type, data) %>% unnest(cols = c(data)) %>% 
  dplyr::select(date, series, value)

p1 <- days_supply %>%
  dplyr::filter(date >= "2018-01-01") %>% 
  ggplot(aes(x = date, y = value)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  ggtitle('Distillate Fuel Oil Days of Supply U.S, Weekly')
p1 %>% plotly::ggplotly(width = 700, height = 400,)
```

+ What we see currently in the ULSD market is that refinery output for the next few quarters is constrained with any increases in domestic US supply being the result of a decrease in net exports in the short-term. In this sense domestic supply is only expected to increase by ~300 thousand barrels a day going into the winter season. 
+ With supply accounted for we need to make some assumptions about demand in the short and long term. In the short term we expect to see higher demand as a result of the cold winter months and home heating requirements, along with a continue push to solve supply chain issues across the US which would require an increase in freight transport during the holiday shopping season. Each of these factors leads us to believe that demand for ULSD in the next few quarters will be strong and outstrip US supply in the near-term. 
```{r, eval=FALSE}
Consumption <- read.csv(file = "~/Practice/consumption_distillate_retail_2.csv")
p20 <- Consumption %>% group_by(YEAR) %>% group_by(quarter)
Consumption %>% plot_ly() %>% add_trace(x = p20, y = ~distillate_fuel, type = 'bar', xaxis = ~YEAR, yaxis = "y", name = 'distillate_fuel') %>% add_trace(x = p20, y = ~heating_retail, type = "scatter", mode = "lines+markers", yaxis = "y2", name = 'heating_retail') %>% layout(yaxis = list(side = "left"), yaxis2 = list(side = "right", overlaying = "y"), showlegend = TRUE)
```
+ US distillate oil days of supply has been on a downward trend since late January 2021 with less than 36 days of supply since August. 

+ Going into the winter months we would expect to see inventories increasing but with the prolonged downward trend it appears that inventory builds will solely be driven by changes in net exports as supply from refineries appears to be inelastic. If demand in the US market during the winter months increases more than the change in net exports we can expect to see increases in inventory draws and decreases in days of distillate supply. 


## Desired Exposure

As we believe that demand will outstrip supply during the winter season we will want to be long during this period. With increased inelastic demand due to transport needs and higher demand due to heating oil needs in the winter coupled with limited inventory builds during the summer we should see higher inventory draws leading to lower days of supply. The anticipated downward trend in days of supply during the winter will likely be the catalyst for higher ULSD prices. In anticipation of these higher prices as inventories decline we could go long the flat price for ULSD, long ULSD and short CL, or long ULSD in a month and short ULSD in the following months. 


## Monetization Strategies

The chart below shows historical days of supply along with the three main monetization strategies of flat price, time spread, and crack spread. 

```{r}
#Putting together days of supply and price strategies (crack spread, time spread, flat price)
#Extracting the 1st and 2nd Contracts
df2 <- RTL::getPrices(
    feed = "CME_NymexFutures_EOD_continuous",
    contracts = c("HO_001_Month","HO_002_Month","CL_001_Month"),
    from = "2010-01-01",
    iuser = iuser,
    ipassword = ipassword)
#Joining the Data Frames, converting to barrels, and calculating spreads
 Comp_df <-  df2 %>%  dplyr::arrange(dplyr::desc(date)) %>% 
  stats::na.omit()%>% 
  dplyr::transmute(date = date,
                   HO_01 = HO_001_Month * 42,
                   HO_02 = HO_002_Month * 42,
                   CL_01 = CL_001_Month,
                   Time_Spread = HO_01 - HO_02,
                   Crack_Spread = HO_01 - CL_01)
 
#Converting days of supply wider
days_supply <- days_supply %>% 
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::rename(Days_Supply = PET.W_EPD0_VSD_NUS_DAYS.W)
 
#Put together and converting from wide to long
Comp_df <- dplyr::inner_join(days_supply,Comp_df) %>% 
  dplyr::select(-HO_02 & -CL_01) %>% 
  dplyr::rename(Flat_Price = HO_01) %>% 
  tidyr::pivot_longer(-date, values_to = "value", names_to = "series")

fig.title = "Flat Price, Time Spread, and Crack Spread Compared to Days of Supply"
t <- Comp_df %>% 
  ggplot(aes(x = date, y = value, color = series)) + 
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = fig.title, y = "Value", x = "")
 t %>% plotly::ggplotly(width = 700, height = 400,)
```

There are a few ways for us to profit off of our market call including making trades on flat price, time spread, and crack spread. With the historical volatility of flat price being quite high we would prefer to make trades based on other strategies. 
We considered a time spread that was long a contract expiring within the next two quarters and being short a contract in the second quarter of 2022. This would mean that we would profit off of any increase in price in the near-term and price decreases following the winter months, aligning with our market view.

We have also considered a strategy involving the crack spread where we would be long ULSD and short CL with the expectation that heightened demand in ULSD will increase the crack spread. This would also allow for possible changes in CL prices in the case that OPEC or US producers increased the supply of CL leading to decreases in the prices of both commodities. With the belief that demand and supply in the short-term for ULSD is relatively inelastic we would expect that price for ULSD to fall at a slower rate than CL in the near-term and for that difference in spread to balance out in the longer term following the holiday season. 

From our analysis of days of supply and various strategies we found that only a few strategies appears to show some form of relationship with days of supply. There does not appear to be a discernible relationship between flat price and days of supply other than the slight lag consistent with producers stockpiling inventories at lower ULSD prices to profit off of future price increases. Time spreads appear to be at their most extreme during the first quarter of the year which is consistent with changes in seasonality at the end of winter. There does appear to be an inverse relationship between days of supply and time-spreads that can be observed when time spreads spike. In the cases of the 2014 and 2015 spikes in time spreads to the double digit range supplies reached a trough before building up again following the winter months. There also appears to be an inverse relationship between the crack spread and the number of days of supply. Generally, when days of supply of ULSD is high the crack spread is low which makes sense as large inventories of ULSD would decrease the price of ULSD relative to CL. Days of supply peaked during the early parts of the COVID-19 Pandemic and corresponds to a steep decline in the crack spread. 

Given our market view that inventories will be pressured in the short-term due to lack of inventory builds prior to the winter we expect to see increases in both the crack and time spreads. At the time of writing the U.S. has roughly 31 days of supply and with the belief that this could go lower during the winter months if export reductions are not significant enough we could expect to see sub-30 days of supply which corresponds to crack spreads upwards of $26 in recent years and time spreads which could reach the low-to-mid teen range if demand is especially high during the end of the winter when inventories have been run down.  


## Risk Appetite
Below are the charts used to determine the volatility and possible payoffs based on the three different monetization strategies. These focus on monetizing the March and April market call where we expect price appreciation of ULSD later in the winter months. 
```{r}
tradeprocess <- RTL::getPrices(feed="CME_NymexFutures_EOD",contracts = c("@CL22H","@HO22J","@HO22H"),
                          from = "2012-01-01",iuser = iuser, ipassword = ipassword) %>% stats::na.omit()

df.long <- tradeprocess %>% tidyr::pivot_longer(cols = -date,
   names_to = "series",
  values_to = "value") %>%
  dplyr::mutate(value = case_when(
    grepl("HO", series) ~ value * 42,
    TRUE ~ value
  ))

# Plot into two panels using facet_grid
fp <- df.long %>%
  dplyr::filter(series == "HO22H") %>%
  dplyr::mutate(PL = value - dplyr::lag(value)) %>%
  stats::na.omit() %>%
  dplyr::select(-series) %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value")

# Plot into two panels using facet_grid
fp1 <- fp %>%
  ggplot(aes(x = date, y = value)) + geom_bar(col = "blue", stat = "identity") +
  facet_grid(series ~ ., scales = "free_y") +
  labs(
    title = "Strategy::Flat Price",
    subtitle = "Price Evolution and Risk/Reward",
    caption = "Source: Morningstar/CME",
    x = "",
    y = "$ per bbl"
  )
fp1 %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
cx <- df.long %>%
  dplyr::filter(series %in% c("HO22H", "CL22H")) %>%
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::transmute(
    date = date,
    value = HO22H - CL22H,
    PL = value - dplyr::lag(value)
  ) %>%
  stats::na.omit() %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value")

# Plot into two panels using facet_grid
cx1 <- cx %>%
  ggplot(aes(x = date, y = value)) + geom_bar(col = "blue", stat = "identity") +
  facet_grid(series ~ ., scales = "free_y") +
  labs(
    title = "Strategy::March Crack Spread",
    subtitle = "Price Evolution and Risk/Reward",
    caption = "Source: Morningstar/CME",
    x = "",
    y = "$ per bbl"
  )
cx1 %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
struct <- df.long %>%
  dplyr::filter(series %in% c("HO22J", "HO22H")) %>%
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::transmute(
    date = date,
    value = HO22H - HO22J,
    PL = value - dplyr::lag(value)
  ) %>%
  stats::na.omit() %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value")

# Plot into two panels using facet_grid
Str <- struct %>%
  ggplot(aes(x = date, y = value)) + geom_bar(col = "blue", stat = "identity") +
  facet_grid(series ~ ., scales = "free_y") +
  labs(
    title = "Strategy::March - April Time Spread",
    subtitle = "Price Evolution and Risk/Reward",
    caption = "Source: Morningstar/CME",
    x = "",
    y = "$ per bbl"
  )
Str %>% plotly::ggplotly(width = 700, height = 400,)
```
```{r}
# Using row bind (rbind) to concatenate long dfs 
res <-
  rbind(
    fp %>% dplyr::filter(series != "value") %>% dplyr::mutate(series = "Flat Price"),
    cx %>% dplyr::filter(series != "value") %>% dplyr::mutate(series = "Crack Spread"),
    struct %>% dplyr::filter(series != "value") %>% dplyr::mutate(series = "Time Spread")
  )

Res <- res %>% ggplot(aes(x = value)) +
  stat_density(mapping = (aes(y = ..scaled..)),
               col = "blue",
               fill = "blue") +
  facet_grid(series ~ .) +
  labs(
    title = "Strategy PL Comparison",
    caption = "Source: Morningstar",
    x = "",
    y = "$ per bbl"
  )
Res %>% plotly::ggplotly(width = 700, height = 400,)
```
Based on the distributions of each strategy it appears that the flat price strategy has the highest risk and the March - April 2022 time spread strategy has the lowest risk. The crack spread has much more moderate risk compared to the flat price strategy but has a much wider distribution than the time spread strategy. 

We feel that the distribution and risk of the flat price strategy is too high for making trades and that the other two strategies have much more reasonable risk distributions. At this time we are comfortable starting with a higher risk, higher reward crack spread strategy and we will likely include the lower risk time spread strategy as a later trade. The crack spread strategy also exposes us to changes in the price of CL which contributes to the higher risk but also provides us the opportunity to benefit from possible increases in the supply of CL and the subsequent decrease in CL prices.

```{r}
library(tibbletime)
# Using RTL and Morningstar to retrieve contract data
df <-  RTL::getPrices(
  feed = "CME_NymexFutures_EOD_continuous",
  contracts = paste0("HO_", sprintf('%0.3d', 1:36), "_Month"),
  from = "2015-01-01",
  iuser = iuser,
  ipassword = ipassword
) %>%
  dplyr::filter(!date %in% c(as.Date("2020-04-20")))

df <- df %>%
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value") %>%
  dplyr::mutate(series = stringr::str_replace_all(series, c("_0" = "", "_Month" = ""))) %>%
  dplyr::group_by(series) %>%
  dplyr::mutate(
    ret_abs = value - dplyr::lag(value),
    ret_rel = (value / dplyr::lag(value)) - 1,
    ret_log = log(value / dplyr::lag(value))
  ) %>%
  stats::na.omit()
## Pivot prices into a wide data frame
prices <- df %>% dplyr::select(date, series, value) %>%
  tidyr::pivot_wider(values_from = value, names_from = series)
```


```{r}
## Pivot returns into a wide data frame
ret_abs <- df %>% dplyr::select(date, series, ret_abs) %>%
  tidyr::pivot_wider(values_from = ret_abs, names_from = series)
ret_log <- df %>% dplyr::select(date, series, ret_log) %>%
  tidyr::pivot_wider(values_from = ret_log, names_from = series)
```

```{r, eval=FALSE}
fig.title = "ULSD Front Contract Absolute Returns"
ret.adj <- RTL::rolladjust(
  x = ret_abs[, 1:2],
  commodityname = c("cmeulsd"),
  rolltype = c("Last.Trade")
) %>%
  mutate(CL01 = cumsum(HO01)) %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>%
  dplyr::mutate(series = "adj")
ret.unajd <- ret_abs[, 1:2] %>% mutate(HO01 = cumsum(HO01))
ARoll <- ret.unajd %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>% 
  rbind(ret.adj) %>%
  ggplot(aes(x = date, y = value, col = series)) + geom_line() +
  labs(
    title = fig.title,
    subtitle = "With and Without Roll Adjustment - series start diverging on the first expiry",
    caption = "Source: CME",
    x = "",
    y = "Cumulative Returns ($)"
  )
ARoll %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
# Roll Adjustment
library(moments)
ret.log.adj <-
  RTL::rolladjust(
    x = ret_log,
    commodityname = c("cmeulsd"),
    rolltype = c("Last.Trade")
  ) %>%
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value")

x <- ret.log.adj %>%
  stats::na.omit() %>%
  dplyr::group_by(series) %>%
  dplyr::summarize(
    mean = mean(value),
    stddev = sd(value),
    kurtosis = moments::kurtosis(value),
    skewness = moments::skewness(value),
    .groups = "keep"
  )
```

```{r}
fig.title = "Risk versus Time to Delivery"

sd.simple <- ret.log.adj %>%
  group_by(series) %>%
  dplyr::summarize(stddev = sd(value) * sqrt(252), .groups = "keep")

SD.Simple <- sd.simple %>% ggplot(aes(x = series, y = stddev)) + geom_point(col = "blue") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(labels = percent) +
  labs(
    title = fig.title,
    subtitle = "notice the volatility cone shape: risk is a function of maturity",
    x = "Contracts",
    y = "Annualized Percentage Volatility"
  )
SD.Simple %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
fig.title = "Box Plot for Risk and Time to Delivery"
 ret.log.adj %>% plot_ly(
  y = ~ value,
  color = ~ series,
  type = "box",
  colors = c("blue", "orange"),
  width = 700,
  height = 400
)  %>%
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(title = ""),
    yaxis = list(
      title = "Daily Returns",
      separators = '.,',
      tickformat = ".0%"
    )
  )
```

```{r}
library(tibbletime)
# Define the rolling function using rollify()
sd20 <- tibbletime::rollify(stats::sd, window = 20)
# We use long data frames in large data sets
ret.roll <- tibbletime::as_tbl_time(ret.log.adj, index = date) %>%
  dplyr::group_by(series) %>%
  dplyr::mutate(sd20 = sd20(value) * sqrt(252)) %>%
  dplyr::ungroup() %>% stats::na.omit()
# Since series is numeric, we use as.factor to have discrete scale
ret.roll %>% dplyr::filter(series %in% c("HO01", "HO06", "HO12", "HO36")) %>%
  plotly::plot_ly(
    x = ~ date,
    y = ~ sd20,
    name = ~ series,
    color = ~ series,
    width = 700,
  height = 400
  ) %>%
  plotly::add_lines() %>%
  plotly::layout(
    title = list(text = "Heteroskedasticity", x = 0),
    xaxis = list(title = ""),
    yaxis = list(title = "Annualized Volality", tickformat = ".0%")
  )
```

```{r}
ret.abs.adj <-
  RTL::rolladjust(
    x = ret_abs,
    commodityname = c("cmeulsd"),
    rolltype = c("Last.Trade")
  )
```

```{r, eval=FALSE}
#Beta chart
 RTL::promptBeta(
  x = ret.abs.adj,
  period = "all",
  betatype = "all",
  output = "chart"
)
```

```{r}
fig.title = "Rolling Correlations"
# Define Rolling Cor from stats::cor() with n=20
# .x and .y and the two generic variables over which we compute return correlation
cor_roll <- tibbletime::rollify( ~ cor(.x, .y), window = 20)

# Data Set in Tibbletime
# Requires time based objects
# Connot cope with non-alphanumeric column names when calling variables in a function

df.corr <- ret.abs.adj %>%
  dplyr::select(date, HO01, HO03, HO12, HO36) %>%
  tibbletime::as_tbl_time(index = date) %>%
  stats::na.omit()

# Applying
df.corr <- df.corr %>%
  dplyr::mutate(
    rho_1_3 = cor_roll(.x = HO01, .y = HO03),
    rho_1_12 = cor_roll(.x = HO01, .y = HO12),
    rho_1_36 = cor_roll(.x = HO01, .y = HO36)
  ) %>%
  stats::na.omit()

# Charting With Minimal Edits if adding more correlations
 df.corr %>% dplyr::select(date, contains("rho")) %>%
  tidyr::pivot_longer(cols = -date,
                      names_to = "series",
                      values_to = "value") %>%
  plotly::plot_ly(
    x = ~ date,
    y = ~ value,
    name = ~ series,
    color = ~ series,
    width = 700,
  height = 400
  ) %>%
  plotly::add_lines() %>%
  plotly::layout(
    title = list(text = fig.title, x = 0),
    xaxis = list(title = ""),
    yaxis = list(title = fig.title, tickformat = ".2f")
  )
```
The above charts are illustrating the relationship between contract volatility and the time to delivery of the contract. The most volatile contract is the front contract and as time to delivery increases the price volatility of the contract decreases. In the longer-term supply and demand are more elastic meaning that consumers and producers can change their behaviors leading to more moderate price changes farther down the curve. In the near-term demand and supply are more inelastic so price changes are more volatile in response to immediate inventory levels and demand swings. Correlations between ULSD contracts are larger when the contract delivery dates are closer together and smaller when delivery times are farther apart. This means that time has a mitigating effect on the near-term price volatility of ULSD as closer contracts will move in line with one another but farther out contracts will not experience price volatility to the same extent. 


## Execution

The first trade that we will be executing will be a crack spread strategy for March in which we are long ULSD and short CL. From our supply demand balance production of ULSD is quite inelastic in the short term and that and increases in domestic U.S. supply will have to be the result of a decrease in exports. Only slight and temporary decreases in exports are expected prior to the winter season so it is not likely that domestic inventories will build up enough to meet demand into the late winter. There was no build up of inventories in the Summer as would be typically suspected resulting in lower inventories going into the Fall with moderate draws of inventory already being realized leading to lower days of supply. We believe that higher demand during the winter season will be fueled by residential heating oil demand and freight transport needs over the holiday season with a continued effort to resolve U.S. supply chain bottlenecks leading to higher than average demand for ULSD. This will leads to draws on inventory which we anticipate will cause the crack spread between ULSD and CL to widen near to February and March as inventories have historically bottomed in those months. The relationship between days of supply and the crack spread appeared to be inverse in historical periods so based on our belief that we will see moderately lower days of inventory in the late winter we expect to profit off the widening of the crack spread. EIA forecasts show that inventories will be at their lowest point for the winter season in March and April which is why we decided to play the March crack spread. 

This will be a longer term strategy that we would expect to pay off closer to the end of March depending on the severity of the winter weather at that time. We do expect to profit off of this trade as we move closer to March and as days of supply decrease after the initial builds due to the decline in ULSD exports. 

Currently the crack spread for March 2022 is ~24 dollars per barrel which we believe is quite low given our expectations of continued inventory draws and lower days of supply during the Winter making the current spread an attractive entry point. Comparable days of supply to today have realized historical crack spreads between ~26 to ~40 dollars depending on the severity of the winter making this trade quite attractive. Trade exit would take place at a price in this range unless market conditions change materially. This trade will involve 15 contracts for both ULSD and CL.

## Profit and Loss

For each strategy:

+ Provide a grid of PL attribution by risk factors (flat price, time spread, crack,) 
+ Is it in line with your market call? Learnings...

## Lessons Learned

What have you learned from this project?

## Questions for Weekly Meeting with Prof

1. What is meant by the hedge ratio and what does it apply to? Is it just for hedging flat price changes or is it used in crack and time spread strategies?
2.  In many cases when the fill function is used to replace missing values when using data that reports on different frequencies it results in horizontal lines in graphs and likely is not representative for use in regressions. Is there any way for us to extrapolate date in a better way for this other than copying a previous observation?
3. How should we construct the P&L chart? Does the program we use to trade provide the historical P&L or do we need to update daily? Or is it total P&L from each strategy?
4. What does the Z-Score represent in relation to seasonality?


## Appendix

```{r, eval=FALSE}
#Extracting the 1st and 2nd Contracts
df <- RTL::getPrices(
    feed = "CME_NymexFutures_EOD_continuous",
    contracts = c("HO_001_Month","CL_001_Month"),
    from = "2010-01-01",
    iuser = iuser,
    ipassword = ipassword)
#Joining the Data Frames, converting to barrels, and calculating spreads
df.long <- df %>% 
  stats::na.omit()%>% 
  dplyr::transmute(date = date,
                   HO_01 = HO_001_Month * 42,
                   CL_01 = CL_001_Month,)%>% 
#Converting from wide to long
  tidyr::pivot_longer(-date, values_to = "Price", names_to = "Contracts")


df.prices <- df.long %>% 
  dplyr::filter(grepl("CL_01|HO_01", Contracts)) %>% 
  tidyr::drop_na()

df.ret <- df.prices %>%
  dplyr::group_by(Contracts) %>%
  dplyr::mutate(ret = Price - dplyr::lag(Price)) %>%
  stats::na.omit()

df.ret.wide <- df.ret %>%
  tidyr::pivot_wider(-Price, values_from = ret, names_from = Contracts) %>% 
  dplyr::filter(!date %in% c(as.Date("2020-04-20"),as.Date("2020-04-21"), as.Date("2020-04-17"))) %>% 
  tidyr::drop_na()

fig.title = paste(colnames(df.ret.wide)[2],"vs",colnames(df.ret.wide)[3],"Relationship")
# A Useful way to Set Equal Axis
axis.lim <- df.ret.wide %>% select(-date) %>% max(abs(.))
df.ret.wide %>%
  ggplot(aes(x = CL_01, y = HO_01, col = date)) + geom_point() +
  ylim(-axis.lim, axis.lim) + xlim(-axis.lim, axis.lim) +
  labs(title = fig.title)

fig.title = paste(colnames(df.ret.wide)[2],
                  "vs",
                  colnames(df.ret.wide)[3],
                  "Relationship Model Fit")
# Running the regression with the stats package
fit <- stats::lm(HO_01 ~ CL_01, data = df.ret.wide)
# Returns an object of type list with all info
# summary(fit), plot(fit)
summary(fit)


# Package broom provides better outputs as data frames
library(broom)
broom::tidy(fit) %>% dplyr::mutate_if(is.numeric, round, 3)

broom::glance(fit) %>% dplyr::mutate_if(is.numeric, round, 3)

# Using broom to plot into ggplot
axis.lim <- df.ret.wide %>% select(-date) %>% max(abs(.))

broom::augment(fit) %>%
  ggplot(aes(x = CL_01, y = HO_01)) + geom_point() +
  stat_smooth(method = lm, formula = y ~ x,se = FALSE) +
  stat_smooth(method = loess, formula = y ~ x,se = FALSE, col = "orange") +
  ylim(-axis.lim, axis.lim) + xlim(-axis.lim, axis.lim) +
  labs(title = fig.title, 
       subtitle = "adding a non-linear fit helps us understand the nature of the relationship")

library(ggfortify)
# ggfortify is required for autoplot for use with an object returned from lm()
autoplot(fit,size = 0.5)
```

```{r, eval=FALSE}
library(RTL)
storage <- rbind(eiaStocks %>% dplyr::filter(series == "CrudeCushing"),
            eiaStorageCap %>% dplyr::filter(series == "Cushing"))

spreads <- dflong %>%
  dplyr::filter(grepl("CL01|CL02", series)) %>% 
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::transmute(date, c1c2 = .[[2]] - .[[3]]) %>% 
  tidyr::drop_na()

spreads <- RTL::rolladjust(x = spreads,commodityname = "cmewti",
                           rolltype = c("Last.Trade"))

spreads <- spreads %>% dplyr::filter(abs(c1c2) < 10)
      
dat <- storage %>%
    tidyr::pivot_wider(names_from = series, values_from = value) %>%
    dplyr::arrange(date) %>%
    dplyr::rename(stocks = 2, capacity = 3) %>%
    tidyr::fill(capacity) %>%
    tidyr::drop_na() %>%
    dplyr::mutate(utilization = stocks / capacity,
                  year = lubridate::year(date)) %>%
    dplyr::left_join(spreads %>% dplyr::select(date, c1c2)) %>%
    tidyr::drop_na() 

dat %>% plotly::plot_ly(
  x = ~ utilization ,
  y = ~ c1c2,
  #name = ~ series,
  color = ~ year,
  type = "scatter",
  mode = "markers"
) %>%
  plotly::layout(
    title = list(text = "Front Spread Structure ($)", x = 0),
    xaxis = list(title = "Front Spread Market Structure vs Storage Utlization"),
    yaxis = list(title = "Cushing Storage Utilization")
  )
```

```{r, eval=FALSE}
library(splines2)
dat <- dat %>% dplyr::filter(abs(c1c2) < 2)
fit <-
  lm(c1c2 ~ splines::bs(utilization,knots = c(.4,.7),
                        degree = 3,
                        intercept = FALSE),
     data = dat)
summary(fit)

library(ggfortify)
autoplot(fit, size = 0.5)

```

```{r, eval=FALSE}
dat %>% ggplot(aes(x = utilization, y = c1c2, col = year)) +
  geom_point() + 
    geom_smooth(
    method = "lm",
    formula = y ~ splines::bs(
      x,
      knots = c(0.4,0.7),
      degree = 3,
      intercept = T
    ),
    se = F,
    col = "red"
  )

```

```{r, eval=FALSE}
#Making Prediction
utilization = data.frame(x = 0.85)
fit %>% stats::predict(newdata = utilization,
                       interval = "prediction",
                       level = 0.99)

```


```{r}
#Utilizing HDD and Forecast to Predict Inventory Levels and Potential Future Prices
#HDD used is for the Middle Atlantic region of the US including NY and Pennsylvania. Should be representative for the New England region as well.
fig.title = "ULSD Demand vs HDD"
x <-
  rbind(
    RTL::eia2tidy("STEO.ZWHDPUS.M", key = EIAkey, name = "HDD"),
    RTL::eia2tidy("STEO.DFTCPUS.M", key = EIAkey, name = "Demand")
  ) %>%
  dplyr::group_by(series) %>%
  dplyr::arrange(date) %>%
  dplyr::mutate(month = lubridate::month(date),
                change = value - dplyr::lag(value)) %>%
  stats::na.omit() %>%
  dplyr::filter(date > "2010-01-01",
                month %in% c(11, 12, 1, 2, 3)) %>%
  dplyr::select(date, series, change, month) %>%
  tidyr::pivot_wider(names_from = series, values_from = change)

HD <-  x %>%
  ggplot(aes(x = HDD, y = Demand, col = as.character(month))) +
  geom_point() +
  labs(title = fig.title)
HD %>% plotly::ggplotly(width = 700, height = 400,)

```
From the above scatterplot it does not appear that there is a clear linear relationship between ULSD demand and the winter months. Heating degree days tend to be concentrated together based on the month so the number of HDD in a month is fairly consistent each year. 

```{r}
# Warnings 
## Demand should be de-trended first
## The relationship may change over time 
fit <- lm(Demand ~ 0 + HDD, data = x)
summary(fit)
```

```{r}
df <-
  tickers_eia %>% dplyr::filter(grepl(pattern = "eia.mdist.stocks.us.dayssupply", x = tick.r)) %>%
  dplyr::mutate(key = EIAkey) %>%
  dplyr::mutate(df = purrr::pmap(list(tick.eia, key, tick.r), .f = RTL::eia2tidy)) %>%
  dplyr::select(df) %>% tidyr::unnest(df)
fig.title = "STL"
RTL::chart_zscore(
  df = df,
  title = fig.title,
  per = "yearweek",
  output = "stl",
  chart = "seasons"
)
```

```{r}
fig.title = "STL Stats"
 RTL::chart_zscore(
  df = df,
  title = fig.title,
  per = "yearweek",
  output = "stats",
  chart = "seasons"
)
```

```{r, eval=FALSE}
#Z-Score
fig.title = "Z Scores"
RTL::chart_zscore(
  df = df,
  title = fig.title,
  per = "yearweek",
  output = "zscore",
  chart = "seasons"
)
```

```{r}
fig.title = "Seasonal"
 RTL::chart_zscore(
  df = df,
  title = fig.title,
  per = "yearweek",
  output = "seasonal",
  chart = "seasons"
)
```

From the STL analysis it appears that there is some consistent seasonality in the days of supply of ULSD. This seasonality appears to be quite strong and appears to coincide with months earlier in the year which is consistent with higher demand in the late winter leading to declines in days of supply. Days of supply appears to decline from January into March and then increases during the spring and summer as heating needs decline. This relationship appears to be consistent between years with the exception of 2020 as COVID-19 led to major unexpected increases in ULSD inventories. 

```{r}
#Regressing Days of Supply and Time Spread. No roll adjustment
Reg <- dplyr::filter(HOdf, Contracts == "HO_c1c2_Spd") %>% 
  dplyr::rename(value = "Price") %>% 
  dplyr::rename(series = "Contracts") %>% 
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  stats::na.omit()

c1c2_Reg <- dplyr::left_join(Reg, days_supply) %>% 
  dplyr::arrange(date) %>% 
  tidyr::fill(Days_Supply) %>% 
  stats::na.omit() %>% 
  dplyr::mutate(year = lubridate::year(date))

c1c2_Reg %>% plotly::plot_ly(
  x = ~ Days_Supply ,
  y = ~ HO_c1c2_Spd,
  #name = ~ series,
  color = ~ year,
  height = 400,
  width = 700,
  type = "scatter",
  mode = "markers"
) %>%
  plotly::layout(
    title = list(text = "Front Spread Market Structure vs Days of Storage", x = 0),
    xaxis = list(title = "Days of Supply"),
    yaxis = list(title = "Time Spread ($)")
  )
```

```{r}
# Running the regression with the stats package
c1c2_Reg <- c1c2_Reg %>% dplyr::filter(abs(HO_c1c2_Spd) < 2)
fit <- lm(HO_c1c2_Spd ~ splines::bs(Days_Supply,knots = c(30,35), degree = 3, intercept = FALSE), data = c1c2_Reg)
summary(fit)

library(ggfortify)
autoplot(fit, size = 0.5)

c1c2_Graph <- c1c2_Reg %>% ggplot(aes(x = Days_Supply, y = HO_c1c2_Spd, col = year)) +
  geom_point() + 
    geom_smooth(
    method = "lm",
    formula = y ~ splines::bs(
      x,
      knots = c(30,35),
      degree = 3,
      intercept = T
    ),
    se = F,
    col = "red"
  ) 
c1c2_Graph %>% plotly::ggplotly(width = 700, height = 400,)

```

```{r}
#Prediction at current days of supply
Days_Supply = data.frame(x = 32.3)
fit %>% stats::predict(newdata = Days_Supply,
                       interval = "prediction",
                       level = 0.99)
```
Using the regression results between the ULSD time spread and days of supply we can assess if the current time spread is reasonable based on the most recent reported days of supply. In this case the most recent values for days of supply is 30.4. When inputting this into the regression we find that the reasonable spread given a 99% confidence interval is between -0.81 and 0.96 while the current spread is roughly $0.64. The current market spread is within the confidence interval but is on the higher side of the distribution meaning that there is a smaller amount of upside potential based on the current days of supply and the regression.
```{r}
#Prediction using potential days of supply
Days_Supply = data.frame(x = 32.3)
fit %>% stats::predict(newdata = Days_Supply,
                       interval = "prediction",
                       level = 0.99)
```
With the combination of our market view that the winter will increase inventory draws for the next two quarters we anticipate seeing declines in the days of ULSD supply. To get a sense of the potential time spread range we input 29.5 days of supply and saw that the potential upside by being long the time spread increased by roughly 14% based on a 95% confidence interval.  

```{r}
#Front Time Spread Risk

struct <- c1c2_Reg %>%
  dplyr::select(date, "HO_c1c2_Spd") %>% 
  tidyr::pivot_longer(-date, names_to = "series", values_to = "value")

# Plot into two panels using facet_grid
Str <- struct %>%
  ggplot(aes(x = date, y = value)) + geom_bar(col = "blue", stat = "identity") +
  facet_grid(series ~ ., scales = "free_y") +
  labs(
    title = "Strategy::Front Time Spread",
    subtitle = "Price Evolution and Risk/Reward",
    caption = "Source: Morningstar/CME",
    x = "",
    y = "$ per bbl"
  )
Str %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r}
#Distribution
Res <- struct %>% ggplot(aes(x = value)) +
  stat_density(mapping = (aes(y = ..scaled..)),
               col = "blue",
               fill = "blue") +
  facet_grid(series ~ .) +
  labs(
    title = "Long Front Time Spread Distribution",
    caption = "Source: Morningstar",
    x = "",
    y = "$ per bbl"
  )
Res %>% plotly::ggplotly(width = 700, height = 400,)
```

```{r, eval=FALSE}
#Regressing Days of Supply and Time Spread. With Roll adjustment
spreads <- dflong %>%
  dplyr::filter(grepl("CL01|CL02", series)) %>% 
  tidyr::pivot_wider(names_from = series, values_from = value) %>% 
  dplyr::transmute(date, c1c2 = .[[2]] - .[[3]]) %>% 
  tidyr::drop_na()

spreads <- RTL::rolladjust(x = spreads,commodityname = "cmewti",
                           rolltype = c("Last.Trade"))

spreads <- spreads %>% dplyr::filter(abs(c1c2) < 10)

Reg <- RTL::rolladjust(x = spreads,commodityname = "cmeulsd",
                           rolltype = c("Last.Trade"))

c1c2_Reg <- dplyr::left_join(Reg, days_supply) %>% 
  dplyr::arrange(date) %>% 
  tidyr::fill(Days_Supply) %>% 
  stats::na.omit() %>% 
  dplyr::mutate(year = lubridate::year(date))

c1c2_Reg %>% plotly::plot_ly(
  x = ~ Days_Supply ,
  y = ~ c1c2,
  #name = ~ series,
  color = ~ year,
  type = "scatter",
  mode = "markers"
) %>%
  plotly::layout(
    title = list(text = "Front Spread Market Structure vs Days of Storage", x = 0),
    xaxis = list(title = "Days of Supply"),
    yaxis = list(title = "Time Spread ($)")
  )
```

```{r, eval=FALSE}
# Running the regression with the stats package
c1c2_Reg <- c1c2_Reg %>% dplyr::filter(abs(c1c2) < 2)
fit <- lm(c1c2 ~ splines::bs(Days_Supply,knots = c(30,35), degree = 3, intercept = FALSE), data = c1c2_Reg)
summary(fit)

autoplot(fit, size = 0.5)

c1c2_Reg %>% ggplot(aes(x = Days_Supply, y = c1c2, col = year)) +
  geom_point() + 
    geom_smooth(
    method = "lm",
    formula = y ~ splines::bs(
      x,
      knots = c(30,35),
      degree = 3,
      intercept = T
    ),
    se = F,
    col = "red"
  )
```

```{r, eval=FALSE}
#Prediction
Days_Supply = data.frame(x = 32.3)
fit %>% stats::predict(newdata = Days_Supply,
                       interval = "prediction",
                       level = 0.99)
```
